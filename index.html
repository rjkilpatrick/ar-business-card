<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <title>AR Optical Fibre - rjkilpatrick</title>
    <meta name="description" content="AR Optical Fibre Simulation">
    <meta name="author" content="John Kilpatrick" />

    <meta property="og:locale" content="en_GB" />
    <meta property="og:title" content="AR Optical Fibre Simulation">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rjkilpatrick.github.io/ar-fibre">
    <meta property="og:description" content="A simple HTML5 Template for new projects.">

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@rjkilpatrick1" />
    <meta name="twitter:title" content="AR Optical Fibre Simulation" />

    <meta name="twitter:creator" content="rjkilpatrick1" />

    <script src="https://unpkg.com/aframe@1.3.0/dist/aframe-master.min.js"></script>
    <!-- Marker based AR -->
    <script src="https://unpkg.com/@ar-js-org/ar.js@3.4.0-alpha-rc2/aframe/build/aframe-ar.js"></script>
    <script>
        {
            const vertexShader = `
                varying vec2 v_uv;

                void main() {
                    v_uv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const fragmentShader = `
                uniform sampler2D u_modeAtlasTexture;
                uniform vec2 u_uvOffset;
                uniform vec2 u_repeat;
                uniform float u_time;
                varying vec2 v_uv;

                // Taken from <https://stackoverflow.com/a/17897228> under WTFPL
                // All components are in the range [0…1], including hue.
                vec3 hsv2rgb(vec3 c) {
                    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
                }

                // Taken from <https://stackoverflow.com/a/17897228> under WTFPL
                // All components are in the range [0…1], including hue.
                vec3 rgb2hsv(vec3 c) {
                    vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
                    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
                    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));

                    float d = q.x - min(q.w, q.y);
                    float e = 1.e-10;
                    return vec3(abs(q.z + (q.w - q.y) / (6. * d + e)), d / (q.x + e), q.x);
                }

                void main() {
                    vec4 original = texture2D(u_modeAtlasTexture, u_repeat * v_uv + u_uvOffset);
                    vec3 hsv = rgb2hsv(original.xyz);
                    hsv.x = fract(hsv.x + (u_time * 3.5e-4));
                    gl_FragColor = vec4(hsv2rgb(hsv), hsv.z);
                }
            `;

            AFRAME.registerShader('fibre-mode', {
                schema: {
                    u_modeAtlasTexture: { type: 'map', is: 'uniform' },
                    u_repeat: { type: 'vec2', is: 'uniform' },
                    u_uvOffset: { type: 'vec2', is: 'uniform' },
                    u_time: { type: 'time', is: 'uniform' },
                },
                vertexShader,
                fragmentShader
            });
        };
    </script>
    <script type="module" src="js/main.js">
    </script>
</head>

<body style="margin : 0px; overflow: hidden;">
    <a-scene embedded arjs vr-mode-ui="enabled: false">
        <a-assets>
            <img id="modes" src="assets/img/mode_texture.png"></img>
        </a-assets>
        <a-marker preset="hiro">
            <!-- Fibre cylinder -->
            <a-cylinder position="0 0.5 0" color="white" height="1" radius="0.5" material="side: double; opacity: 0.2;"
                open-ended="true" rotation="0 0 0"></a-cylinder>

            <!-- Fibre-mode plane -->
            <a-plane id="fibre-plane" position="0 0 0"
                animation="property: position; to: 0 1 0; dur: 3000; easing: linear; loop: true" material="shader:fibre-mode;
                u_modeAtlasTexture: #modes;
                u_repeat: 0.08333333333 0.08333333333;
                u_uvOffset: 0.0, 0.0;
                transparent: true;" rotation="-90 0 0"></a-plane>
        </a-marker>
        <a-text text="" rotation="-90 0 0" position="0.5 0 -0.5" id="mode-text" scale="0.5 0.5 0.5"></a-text>
        <a-entity camera></a-entity>
    </a-scene>
</body>

</html>